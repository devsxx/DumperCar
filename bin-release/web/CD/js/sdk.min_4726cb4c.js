'use strict';class Util{static isStartWith(a,b){let c=b.length;return 0<=c&&0===a.indexOf(b)}static showLoading(a){!this.loading&&wx.showLoading&&(this.loading=!0,wx.showLoading({title:a,mask:!0}))}static hideLoading(){this.loading=!1,wx.showLoading&&wx.hideLoading()}static assign(c,a){if(Object.assign)return Object.assign(c,a);for(let b in a)c[b]=a[b];return c}static jsonToQuery(a){let b=[];for(let c in a)b.push(`${c}=${a[c]}`);return b.join('&')}static queryToJson(a){let b={},c=decodeURIComponent(a),d=c.split('&');for(let c in d){let a=d[c].split('=');b[a[0]]=a[1]}return b}static resetBaseDef(a,b){for(let c in a=a||{},b=b||{},b)a[c]='undefined'==typeof a[c]?b[c]:a[c];return a}static getWXErrInfo(a){let b=a.errMsg.split(' ');return 2==b.length?b[1]:2<b.length?msg.slice(1).join(' '):'fail'}}let consts={};consts.Version='1.1.3',consts.ClientVer='v1.0.0',consts.RunModeType={Dev:'Dev',Test:'Test',Prod:'Prod'},consts.RunMode=consts.RunModeType.Dev,consts.NetURL={Dev:{serverURL:'https://gc.hortor010.com',wsURL:''},Test:{serverURL:'https://wxmini-test.hortor.net',wsURL:''},Prod:{serverURL:'https://wxmini.hortor.net',wsURL:''}},consts.MessageHead={Login:'/mini/api/v1/code',WeakLogin:'/mini/api/v1/code/weak',SetUserInfo:'/mini/api/v1/userinfo',CreateOrder:'/mini/api/v1/order',MinigameCallback:'/mini/api/v1/pay/callback',ShareInfo:'/mini/api/v1/shareinfo',MpBinding:'/mini/api/v1/sdk/binding',Log:'/mini/api/v1/log'},consts.Errors={NetWorkErr:{errCode:1e3,errMsg:'\u7F51\u7EDC\u9519\u8BEF'},WXCodeErr:{errCode:1001,errMsg:'\u5FAE\u4FE1Code\u83B7\u53D6\u5931\u8D25'},PayCancel:{errCode:1002,errMsg:'\u652F\u4ED8\u53D6\u6D88'},PayFail:{errCode:1003,errMsg:'\u652F\u4ED8\u5931\u8D25'},WXSessionFail:{errCode:1004,errMsg:'\u5FAE\u4FE1session\u83B7\u53D6\u5931\u8D25'},WXGetShareInfoFail:{errCode:1005,errMsg:'\u83B7\u53D6\u5206\u4EAB\u6570\u636E\u5931\u8D25'}},consts.StorageKeys={UserInfo:'__miniSDK_User_Info',RunMode:'__miniSDK_Run_Mode',SaveTime:'__miniSDK_Save_Time',FailOrders:'__miniSDK_Fail_Orders'};class NetWork{constructor(){}init(a){this.Server_URL=consts.NetURL[a.env].serverURL,a.Server_URL&&(this.Server_URL=a.Server_URL)}request(a,b,c){let d=Util.assign({},c.params),e='',f='';for(let g in d)''!=e&&(e+='&',f+='&'),e+=g+'='+encodeURIComponent(d[g]),f+=g+'='+d[g];wx.request({url:this.Server_URL+b,data:e,method:a,header:{"content-type":'application/x-www-form-urlencoded'},success:(a)=>{let b=a.data;return 200==a.statusCode?0==b.meta.errCode?void c.success(b.data):c.fail({errMsg:b.meta.errMsg,errCode:b.meta.errCode}):c.fail({errMsg:b.errMsg||b||'',errCode:consts.Errors.NetWorkErr.errCode})},fail:(a)=>{console.warn('wx.request fail');let b=a.errMsg||a||'';c.fail({errMsg:b,errCode:consts.Errors.NetWorkErr.errCode})}})}get(a,b){b.retry=0,this.request('GET',a,b)}post(a,b){b.retry=0,this.request('POST',a,b)}}class LogManager{handleOnShow(a){this.lastLaunchOptions=a;let b={},c=wx.getStorageSync(consts.StorageKeys.UserInfo);if(b.gameId=this.conf.gameId,b.logType=1,b.content=a,b.scene=parseInt(b.content.scene),console.log(a),this.channel='hortor',b.content.query.channel&&''!=b.content.query.channel&&(this.channel=b.content.query.channel),b.content.query.scene){this.pageQuery=b.content.query.scene;let a=Util.queryToJson(b.content.query.scene);a.channel&&(this.channel=a.channel)}if(1074==b.scene&&(this.sceneQuery=b.content.query),b.content.query.shareConfigId&&(this.shareConfigId=b.content.query.shareConfigId),b.content.query.h_shareCode&&(this.h_shareCode=b.content.query.h_shareCode),b.channel=this.channel,b.shareConfigId=this.shareConfigId,this.scene=b.scene,c){let a=c.userSdk.userId,d=c.userSdk.uniqueId;b.userId=a,b.uniqueId=d}else return;this.postLog(b)}init(a){this.channel='hortor',this.shareConfigId='',this.h_shareCode='',this.scene=0,this.pageQuery='',this.sceneQuery={},this.conf=a,this.network=new NetWork,this.network.init(a);let b=wx.getLaunchOptionsSync();this.handleOnShow(b),wx.onShow(this.handleOnShow.bind(this))}repostSceneLog(){this.handleOnShow(this.lastLaunchOptions)}postLog(a,b){let c={url:this.network.Server_URL+consts.MessageHead.Log,method:'post',data:a};b!=void 0&&(c=Object.assign(c,b)),wx.request(c)}static getInstance(a){return this.instance||(this.instance=new LogManager,this.instance.init(a)),this.instance}}class LoginManager{init(a){this.network=new NetWork,this.network.init(a),this.conf=a,this.log=LogManager.getInstance(a)}checkLoginStorage(){}getStorage(){console.log('getStorage');let a=wx.getStorageSync(consts.StorageKeys.UserInfo);if(a){this._isAuthorizeLogin&&!a.userSdk.hasUserInfo&&(a=null),this._needBindCode()&&(a=null);let b=wx.getStorageSync(consts.StorageKeys.SaveTime);if(b){let c=604800;this.conf.Expire_Time&&(c=parseInt(this.conf.Expire_Time));let d=Math.floor(new Date().getTime()/1e3);b+c<d&&(wx.removeStorageSync(consts.StorageKeys.SaveTime),a=null)}else a=null}return a}checkSession(a){let b=this;wx.checkSession({success:()=>{a(b.getStorage(),null)},fail:()=>{b._clearStorage(),a(null,consts.Errors.WXSessionFail)}})}_clearStorage(){wx.removeStorageSync(consts.StorageKeys.UserInfo)}wxLogin(a){wx.login({success:(b)=>{b.code?(this.code=b.code,a(b.code,null)):(console.warn('\u83B7\u53D6\u7528\u6237\u767B\u5F55\u51ED\u8BC1\u5931\u8D25 -'+b.errMsg),a(null,consts.Errors.WXCodeErr))},fail:(b)=>{console.warn('\u83B7\u53D6\u7528\u6237\u767B\u5F55\u6001\u5931\u8D25! -'+b.errMsg),a(null,consts.Errors.WXCodeErr)}})}entry(a,b){let c=this,d=this.log.channel,e=consts.MessageHead.Login,f=c.log.h_shareCode;this.network.post(e,{params:{code:a,version:consts.Version,gameId:c.conf.gameId,channel:d,query:c.log.pageQuery,shareConfigId:c.log.shareConfigId,h_shareCode:f,isWeak:!c._isAuthorizeLogin},success:function(a){let d=a;if(console.log('login:',a),d.encryptUserInfo){let a=wx.getStorageSync(consts.StorageKeys.UserInfo);console.log('userInfo:',a);let b=!1;a||(b=!0);let e=Math.floor(new Date().getTime()/1e3);wx.setStorageSync(consts.StorageKeys.UserInfo,d),wx.setStorageSync(consts.StorageKeys.RunMode,c.conf.env),wx.setStorageSync(consts.StorageKeys.SaveTime,e),b&&c.log.repostSceneLog()}b(d,null)},fail:function(a){b(null,a)}})}postUserInfo(a,b){Util.hideLoading();var c=this;this.network.post(consts.MessageHead.SetUserInfo,{params:{entryAlias:'minisdk',gameId:c.conf.gameId,userId:b.userId,uniqueId:b.uniqueId,encryptedData:a.encryptedData,iv:a.iv},success:function(a){if(a.encryptUserInfo){let b=wx.getStorageSync(consts.StorageKeys.UserInfo);console.log('userInfo:',b);let d=!1;b||(d=!0);let e=Math.floor(new Date().getTime()/1e3);wx.setStorageSync(consts.StorageKeys.UserInfo,a),wx.setStorageSync(consts.StorageKeys.RunMode,c.conf.env),wx.setStorageSync(consts.StorageKeys.SaveTime,e),d&&c.log.repostSceneLog()}c.next(a.encryptUserInfo,null,c.checkSessionPass)},fail:function(a){c.next(null,a,c.checkSessionPass)}})}fetchUserInfo(a){wx.getUserInfo({lang:'zh_CN',success:(b)=>{this.postUserInfo(b,a)},fail:(a)=>{console.warn('\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25-',a.errMsg),this.next(null,consts.Errors.NetWorkErr,this.checkSessionPass)}})}_bindCode(a){console.log('_bindCode');let b=wx.getStorageSync(consts.StorageKeys.UserInfo);if(!b)return void a();if(this._needBindCode()){let c=b.userSdk.userId,d=this.log.sceneQuery,e=this;this.network.post(consts.MessageHead.MpBinding,{params:{code:d.code,gameId:e.conf.gameId,userId:c},success:function(){a()},fail:function(){a()}})}else a()}_needBindCode(){let a=!1,b=this.log.sceneQuery;return console.log(b),1==b.tp&&(1074==this.log.scene||1073==this.log.scene)&&(a=!0),a}_toSetting(a){let b=this;wx.openSetting({success:(c)=>{c.authSetting['scope.userInfo']?a():wx.showModal({title:'\u63D0\u793A',content:'\u9700\u8981\u8BBE\u7F6E\u5F00\u542F\u5FAE\u4FE1\u8BBF\u95EE\u4FE1\u606F\u6743\u9650',showCancel:!0,cancelText:'\u77E5\u9053\u4E86',confirmText:'\u53BB\u8BBE\u7F6E',success:(c)=>{c.confirm&&b._toSetting(a)}})},fail:()=>{wx.showModal({title:'\u63D0\u793A',content:'\u9700\u8981\u8BBE\u7F6E\u5F00\u542F\u5FAE\u4FE1\u8BBF\u95EE\u4FE1\u606F\u6743\u9650',showCancel:!0,cancelText:'\u77E5\u9053\u4E86',confirmText:'\u53BB\u8BBE\u7F6E',success:(c)=>{c.confirm&&b._toSetting(a)}})}})}_wxAuthorize(a){let b=this;wx.authorize({scope:'scope.userInfo',success:()=>{a()},fail:()=>{b._toSetting(a)}})}_doLogin(a){Util.showLoading('\u767B\u5F55\u4E2D...'),this.next=a;let b=this;this.checkSession((a,c)=>{if(console.log('checkSession'),b.checkSessionPass=!c,wx.getStorageSync(consts.StorageKeys.RunMode)!==this.conf.env&&(b.checkSessionPass=!1),!b.checkSessionPass||!a)b.wxLogin((a)=>{console.log('wxLogin'),b._bindCode(()=>{console.log('that._bindCode'),b.entry(a,(a,c)=>{if(Util.hideLoading(),c)return void b.next(null,c,b.checkSessionPass);let d=()=>{let c=a.userSdk,d=a.encryptUserInfo;b.log.postLog({gameId:b.conf.gameId,userId:c.userId,uniqueId:c.uniqueId,channel:b.log.channel,scene:b.log.scene,logType:3}),c.isAuth?b.next(d,null,b.checkSessionPass):b.fetchUserInfo(c)};b._isAuthorizeLogin?b._wxAuthorize(d):d()})})});else{Util.hideLoading();let c=a.userSdk;b.log.postLog({gameId:b.conf.gameId,userId:c.userId,uniqueId:c.uniqueId,channel:b.log.channel,scene:b.log.scene,logType:3}),b.next(a.encryptUserInfo,null,b.checkSessionPass)}})}login(a){this._isAuthorizeLogin=!0,this._doLogin(a)}weakLogin(a){this._isAuthorizeLogin=!1,this._doLogin(a)}}class PayManagerGame{init(a){this.conf=this.conf||a,this.network=new NetWork,this.network.init(a)}pay(a,b){this._createOrder(a,b)}saveFailOrder(a){let b=[];b.push(a),wx.setStorageSync(consts.StorageKeys.FailOrders,b)}getFailOrders(){let a=wx.getStorageSync(consts.StorageKeys.FailOrders);return a||(a=[]),a}cleanFailOrders(){wx.removeStorageSync(consts.StorageKeys.FailOrders)}reportFailOrders(a,b){if(0>=a.length)return;let c=this;this.postLog(a[0],{success:(a)=>{'success'==a?(c.cleanFailOrders(),b.success&&b.success()):b.fail&&b.fail()},fail:()=>{b.fail&&b.fail()}})}postLog(a,b){this.network.post(consts.MessageHead.MinigameCallback,{params:{orderId:a},success:(a)=>{b.success(a)},fail:()=>{b.fail()}})}syncFailOrders(a){this.reportFailOrders(this.getFailOrders(),a)}orderCallBackHandle(a,b,c){if(null!=b){let b=this;b.saveFailOrder(a)}c(b)}_createOrder(a,b){let c=a.midashiPayInfo,d=a.orderId;var e=Object.assign({},c);let f=this;e.success=()=>{this.network.post(consts.MessageHead.MinigameCallback,{params:{orderId:d},success:(a)=>{let c=null;'success'!=a&&(c=consts.Errors.PayFail),f.orderCallBackHandle(d,c,b)},fail:()=>{f.orderCallBackHandle(d,consts.Errors.PayFail,b)}})},e.fail=(a)=>{b(a)},e.complete=()=>{},console.warn('requestMidasPayment:',e);let g=wx.getSystemInfoSync();console.warn(g),'ios'!=g.platform&&wx.requestMidasPayment(e)}}class ShareManagerGame{constructor(){}_getUserSDKStorage(){let a=wx.getStorageSync(consts.StorageKeys.UserInfo);return a.userSdk}_getUserSDKChannel(){let a=this._getUserSDKStorage(),b='hortor_';return a&&a.channel&&(a.channel.indexOf('_')+1==a.channel.length?b=a.channel:b=a.channel+'_'),b}_getUserSDKShareCode(){let a=this._getUserSDKStorage();return a&&a.h_shareCode?a.h_shareCode:''}_getSDKAppendStr(a){let b=[],c='channel='+this._getUserSDKChannel();b.push(c),c='h_shareCode='+this._getUserSDKShareCode(),b.push(c);let d=a;return a?d+='&'+b.join('&'):d=''+b.join('&'),console.log('[SDK Share Query]:',d),d}_getShareConfigId(a){let b=Util.queryToJson(a);return b.shareConfigId?b.shareConfigId:''}postLog(a){let b=wx.getStorageSync(consts.StorageKeys.UserInfo),c='',d='';b&&(c=b.userSdk.userId,d=b.userSdk.uniqueId);let e=this._getShareConfigId(a.query);this.log.postLog({gameId:this.conf.gameId,logType:2,userId:c,content:a,uniqueId:d,shareConfigId:e})}init(a){this.conf=this.conf||a,this.network=new NetWork,this.network.init(a),this.log=LogManager.getInstance(a),wx.onShareAppMessage(()=>{let a=this.conf.shareData;return this.onShareCb&&(a=this.onShareCb()),a.query=this._getSDKAppendStr(a.query),this.postLog(Object.assign(a,{})),a})}getShareInfo(a,b){wx.getShareInfo({shareTicket:a.shareTicket,success:(c)=>{if('getShareInfo:ok'==c.errMsg){let e=Object.assign(c,a);this._getShareInfo(e,b)}else b(null,consts.WXGetShareInfoFail)},fail:()=>{b(null,consts.WXGetShareInfoFail)}})}_getShareInfo(a,b){a.openId&&(a.userId=a.openId,delete a.openId),this.network.post(consts.MessageHead.ShareInfo,{params:a,success:(a)=>{a.openGId?b(a,null):b(null,consts.WXGetShareInfoFail)},fail:()=>{b(null,consts.WXGetShareInfoFail)}})}_shareCallBack(){let a=this;return{success:(b)=>{console.log('_shareCallBack success'),a.postLog(Object.assign(a.originShareData,{}));let c=a.originShareCbs.success;c&&c(b)},fail:()=>{console.log('_shareCallBack cannel');let a=this.originShareCbs.fail;a&&a()}}}shareAppMessage(a){a.query=this._getSDKAppendStr(a.query),this.originShareCbs={},a.success&&(this.originShareCbs.success=a.success),a.fail&&(this.originShareCbs.fail=a.fail),this.originShareData=a;let b=Object.assign(a,this._shareCallBack());wx.shareAppMessage(b)}onShareAppMessage(a){a&&(this.onShareCb=a)}}let SDK={login(a){this.loginManager.login(a)},weakLogin(a){this.loginManager.weakLogin(a)},pay(a,b){this.payManager.pay(a,b)},getShareInfo(a,b){this.shareManagerGame.getShareInfo(a,b)},shareAppMessage(a){this.shareManagerGame.shareAppMessage(a)},onShareAppMessage(a){this.shareManagerGame.onShareAppMessage(a)},reportFailOrders(a){this.payManager.syncFailOrders(a)},init(a){a.sdkType='minigame';let b=new LoginManager,c=new PayManagerGame,d=new ShareManagerGame;b.init(a),c.init(a),d.init(a),this.loginManager=b,this.payManager=c,this.shareManagerGame=d}};module.exports=SDK;