'use strict';class Util{static isStartWith(a,b){let c=b.length;return 0<=c&&0===a.indexOf(b)}static showLoading(a){!this.loading&&wx.showLoading&&(this.loading=!0,wx.showLoading({title:a,mask:!0}))}static hideLoading(){this.loading=!1,wx.showLoading&&wx.hideLoading()}static assign(c,a){if(Object.assign)return Object.assign(c,a);for(let b in a)c[b]=a[b];return c}static jsonToQuery(a){let b=[];for(let c in a)b.push(`${c}=${a[c]}`);return b.join('&')}static resetBaseDef(a,b){for(let c in a=a||{},b=b||{},b)a[c]='undefined'==typeof a[c]?b[c]:a[c];return a}static getWXErrInfo(a){let b=a.errMsg.split(' ');return 2==b.length?b[1]:2<b.length?msg.slice(1).join(' '):'fail'}}let consts={};consts.Version='1.0.5',consts.ClientVer='v1.0.0',consts.RunModeType={Dev:'Dev',Test:'Test',Prod:'Prod'},consts.RunMode=consts.RunModeType.Dev,consts.NetURL={Dev:{serverURL:'https://gc.hortor010.com',wsURL:''},Test:{serverURL:'https://wxmini-test.hortor.net',wsURL:''},Prod:{serverURL:'https://wxmini.hortor.net',wsURL:''}},consts.MessageHead={Login:'/mini/api/v1/code',SetUserInfo:'/mini/api/v1/userinfo',CreateOrder:'/mini/api/v1/order',MinigameCallback:'/mini/api/v1/pay/callback',ShareInfo:'/mini/api/v1/shareinfo'},consts.Errors={NetWorkErr:{errCode:1e3,errMsg:'\u7F51\u7EDC\u9519\u8BEF'},WXCodeErr:{errCode:1001,errMsg:'\u5FAE\u4FE1Code\u83B7\u53D6\u5931\u8D25'},PayCancel:{errCode:1002,errMsg:'\u652F\u4ED8\u53D6\u6D88'},PayFail:{errCode:1003,errMsg:'\u652F\u4ED8\u5931\u8D25'},WXSessionFail:{errCode:1004,errMsg:'\u5FAE\u4FE1session\u83B7\u53D6\u5931\u8D25'},WXGetShareInfoFail:{errCode:1005,errMsg:'\u83B7\u53D6\u5206\u4EAB\u6570\u636E\u5931\u8D25'}},consts.StorageKeys={UserInfo:'__miniSDK_User_Info',RunMode:'__miniSDK_Run_Mode'};class NetWork{constructor(){}init(a){this.Server_URL=consts.NetURL[a.env].serverURL,a.Server_URL&&(this.Server_URL=a.Server_URL)}request(a,b,c){let d=Util.assign({},c.params),e='',f='';for(let g in d)''!=e&&(e+='&',f+='&'),e+=g+'='+encodeURIComponent(d[g]),f+=g+'='+d[g];console.log(this.Server_URL+b);wx.request({url:this.Server_URL+b,data:e,method:a,header:{"content-type":'application/x-www-form-urlencoded'},success:(a)=>{let b=a.data;return 200==a.statusCode?0==b.meta.errCode?void c.success(b.data):c.fail({errMsg:b.meta.errMsg,errCode:b.meta.errCode}):c.fail({errMsg:b.errMsg||b||'',errCode:consts.Errors.NetWorkErr.errCode})},fail:(a)=>{console.warn('wx.request fail');let b=a.errMsg||a||'';c.fail({errMsg:b,errCode:consts.Errors.NetWorkErr.errCode})}})}get(a,b){b.retry=0,this.request('GET',a,b)}post(a,b){b.retry=0,this.request('POST',a,b)}}class LoginManager{init(a){this.network=new NetWork,this.network.init(a),this.conf=a}checkLoginStorage(){}getStorage(){let a=wx.getStorageSync(consts.StorageKeys.UserInfo);return a}checkSession(a){let b=this;wx.checkSession({success:()=>{a(b.getStorage(),null)},fail:()=>{a(b.getStorage(),consts.Errors.WXSessionFail)}})}wxLogin(a){wx.login({success:(b)=>{b.code?(this.code=b.code,a(b.code,null)):(console.warn('\u83B7\u53D6\u7528\u6237\u767B\u5F55\u51ED\u8BC1\u5931\u8D25 -'+b.errMsg),a(null,consts.Errors.WXCodeErr))},fail:(b)=>{console.warn('\u83B7\u53D6\u7528\u6237\u767B\u5F55\u6001\u5931\u8D25! -'+b.errMsg),a(null,consts.Errors.WXCodeErr)}})}entry(a,b){let c=this;this.network.post(consts.MessageHead.Login,{params:{code:a,version:consts.Version,gameId:c.conf.gameId},success:function(a){let d=a;d.encryptUserInfo&&(wx.setStorageSync(consts.StorageKeys.UserInfo,d),wx.setStorageSync(consts.StorageKeys.RunMode,c.conf.env)),b(d,null)},fail:function(){b(null,consts.Errors.NetWorkErr)}})}postUserInfo(a,b){Util.hideLoading();var c=this;this.network.post(consts.MessageHead.SetUserInfo,{params:{entryAlias:'minisdk',gameId:c.conf.gameId,userId:b.userId,encryptedData:a.encryptedData,iv:a.iv},success:function(a){c.next(a.encryptUserInfo,null,c.checkSessionPass)},fail:function(){c.next(null,consts.Errors.NetWorkErr,c.checkSessionPass)}})}fetchUserInfo(a){wx.getUserInfo({lang:'zh_CN',success:(b)=>{this.postUserInfo(b,a)},fail:(a)=>{console.warn('\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u5931\u8D25-',a.errMsg),this.next(null,consts.Errors.NetWorkErr,this.checkSessionPass)}})}_toSetting(a){let b=this;wx.openSetting({success:(c)=>{c.authSetting['scope.userInfo']?b._doLogin(a):wx.showModal({title:'\u63D0\u793A',content:'\u9700\u8981\u8BBE\u7F6E\u5F00\u542F\u5FAE\u4FE1\u8BBF\u95EE\u4FE1\u606F\u6743\u9650',showCancel:!0,cancelText:'\u77E5\u9053\u4E86',confirmText:'\u53BB\u8BBE\u7F6E',success:(c)=>{c.confirm&&b._toSetting(a)}})},fail:()=>{wx.showModal({title:'\u63D0\u793A',content:'\u9700\u8981\u8BBE\u7F6E\u5F00\u542F\u5FAE\u4FE1\u8BBF\u95EE\u4FE1\u606F\u6743\u9650',showCancel:!0,cancelText:'\u77E5\u9053\u4E86',confirmText:'\u53BB\u8BBE\u7F6E',success:(c)=>{c.confirm&&b._toSetting(a)}})}})}_wxAuthorize(a){let b=this;wx.authorize({scope:'scope.userInfo',success:()=>{b._doLogin(a)},fail:()=>{this._toSetting(a)}})}_doLogin(a){Util.showLoading('\u767B\u5F55\u4E2D...'),this.next=a,this.checkSession((a,b)=>{this.checkSessionPass=!b,wx.getStorageSync(consts.StorageKeys.RunMode)!==this.conf.env&&(this.checkSessionPass=!1),this.checkSessionPass&&a?(Util.hideLoading(),this.next(a.encryptUserInfo,null,this.checkSessionPass)):this.wxLogin((a)=>{this.entry(a,(a,b)=>{if(Util.hideLoading(),b)return void this.next(null,b,this.checkSessionPass);let c=a.userSdk,d=a.encryptUserInfo;c.isAuth?this.next(d,null,this.checkSessionPass):this.fetchUserInfo(c)})})})}login(a){this._wxAuthorize(a)}}class PayManagerGame{init(a){this.conf=this.conf||a,this.network=new NetWork,this.network.init(a)}pay(a,b){this._createOrder(a,b)}_createOrder(a,b){let c=a.midashiPayInfo,d=a.orderId;var e=Object.assign({},c);e.success=()=>{this.network.post(consts.MessageHead.MinigameCallback,{params:{orderId:d},success:(a)=>{'success'==a?b(null):b(consts.Errors.PayFail)},fail:(a)=>{b(a)}})},e.fail=(a,c)=>{let d={};d.errMsg=a,d.errCode=c,b(d)},e.complete=()=>{},console.warn('requestMidasPayment:',e);let f=wx.getSystemInfoSync();console.warn(f),'ios'!=f.platform&&wx.requestMidasPayment(e)}}class ShareManagerGame{constructor(){}init(a){this.conf=this.conf||a,this.network=new NetWork,this.network.init(a)}getShareInfo(a,b){wx.getShareInfo({shareTicket:a.shareTicket,success:(c)=>{if('getShareInfo:ok'==c.errMsg){let e=Object.assign(c,a);this._getShareInfo(e,b)}else b(null,consts.WXGetShareInfoFail)},fail:()=>{b(null,consts.WXGetShareInfoFail)}})}_getShareInfo(a,b){a.openId&&(a.userId=a.openId,delete a.openId),this.network.post(consts.MessageHead.ShareInfo,{params:a,success:(a)=>{a.openGId?b(a,null):b(null,consts.WXGetShareInfoFail)},fail:()=>{b(null,consts.WXGetShareInfoFail)}})}shareAppMessage(a){wx.shareAppMessage(a)}}let SDK={login(a){this.loginManager.login(a)},pay(a,b){this.payManager.pay(a,b)},getShareInfo(a,b){this.shareManagerGame.getShareInfo(a,b)},shareAppMessage(a){this.shareManagerGame.shareAppMessage(a)},init(a){a.sdkType='minigame';let b=new LoginManager,c=new PayManagerGame,d=new ShareManagerGame;b.init(a),c.init(a),d.init(a),this.loginManager=b,this.payManager=c,this.shareManagerGame=d}};module.exports=SDK;